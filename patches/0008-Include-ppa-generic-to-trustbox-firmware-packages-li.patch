From 805ae813a39894a11b9cdf2bd8ed5ae2c67e84f9 Mon Sep 17 00:00:00 2001
From: Nicholas Pridybailo <nikolai.pridybailo@edality.by>
Date: Wed, 24 Apr 2019 15:41:32 +0300
Subject: [PATCH 8/9] Include ppa-generic to trustbox firmware packages list

---
 Makefile                        |  2 +-
 configs/board/trustbox/manifest | 16 ++--------------
 configs/trustbox.cfg            |  4 +++-
 packages/firmware/Makefile      | 19 +++++++++++++++----
 tools/flex-builder              |  2 +-
 5 files changed, 22 insertions(+), 21 deletions(-)

diff --git a/Makefile b/Makefile
index 8169ea0..15e4553 100644
--- a/Makefile
+++ b/Makefile
@@ -18,7 +18,7 @@ all:
 ifeq ($(CONFIGLIST), build_lsdk.cfg)
 uboot uefi bin-firmware $(FIRMWARE_REPO_LIST):
 else
-uboot uefi rcw bin-firmware $(FIRMWARE_REPO_LIST):
+uboot uefi rcw ppa-generic bin-firmware $(FIRMWARE_REPO_LIST):
 endif
 	@$(MAKE) -C $(FBDIR)/packages/firmware $@
 
diff --git a/configs/board/trustbox/manifest b/configs/board/trustbox/manifest
index 111b518..4d298fb 100644
--- a/configs/board/trustbox/manifest
+++ b/configs/board/trustbox/manifest
@@ -4,22 +4,10 @@ machine=trustbox
 # [linux, dtb, rfs]
 kernel_img=build/linux/kernel/arm64/LS/Image
 device_tree=build/linux/kernel/arm64/LS/trustbox.dtb
-ramdiskrfs=packages/rfs/ramdiskrfs/ramdisk_rootfs_arm64.ext4.gz
-kernelrfs_continuous=y
 
 # [firmware_images]
-rcw_qspi=build/firmware/rcw/ls1012afrdm/N_SSNP_3305/rcw_800.bin.swapped
-uboot_qspiboot=build/firmware/u-boot/ls1012afrdm/uboot_ls1012afrdm_qspi.bin
-atf_bl2_qspi=build/firmware/atf/ls1012afrdm/bl2_qspi.pbl
-atf_bl2_qspi_sec=build/firmware/atf/ls1012afrdm/bl2_qspi_sec.pbl
-atf_fip_uboot=build/firmware/atf/ls1012afrdm/fip_uboot.bin
-atf_fip_uboot_sec=build/firmware/atf/ls1012afrdm/fip_uboot_sec.bin
+rcw_qspi=build/firmware/rcw/trustbox/N_SSNH_3308/rcw_800.bin.swapped
+uboot_qspiboot=build/firmware/u-boot/trustbox/uboot_trustbox_qspi.bin
 pfe_fw=build/firmware/qoriq-engine-pfe-bin/ls1012a/u-boot/pfe_fw_sbl.itb
 pfe_kernel=build/firmware/qoriq-engine-pfe-bin/ls1012a/slow_path/ppfe*.elf
 rtl8723bu_fw=build/linux/linux/arm64/LS/lib/firmware/rtl_bt/rtl8723b_fw.bin
-secureboot_headers=null
-
-# [distro autoboot script]
-uboot_scr=build/firmware/u-boot/trustbox/trustbox_boot.scr
-bootscript_dec=build/firmware/u-boot/trustbox/trustbox_dec_boot.scr
-bootscript_enforce=build/firmware/u-boot/trustbox/trustbox_enforce_boot.scr
diff --git a/configs/trustbox.cfg b/configs/trustbox.cfg
index e1e255e..0073bc6 100644
--- a/configs/trustbox.cfg
+++ b/configs/trustbox.cfg
@@ -8,6 +8,7 @@ DISTRIB_VERSION=19.03
 # set default components for autobuild
 CONFIG_BUILD_ATF=n
 CONFIG_BUILD_RCW=y
+CONFIG_BUILD_PPA=y
 CONFIG_BUILD_UBOOT=y
 CONFIG_BUILD_UEFI=n
 CONFIG_BUILD_LINUX=y
@@ -100,7 +101,6 @@ fbdockerimgversion=18.04
 firmware_repo_list="atf u-boot qoriq-uefi-binary qoriq-fm-ucode mc-utils qoriq-mc-binary qoriq-qe-ucode qoriq-firmware-cortina qoriq-firmware-inphi qoriq-engine-pfe-bin ddr-phy-binary"
 linux_repo_list="linux cryptodev-linux lttng-modules rtl8723bu"
 apps_repo_list="restool flib fmlib fmc spc dpdk vpp pktgen-dpdk ovs-dpdk openssl gpp-aioptool cst aiopsl ptpd ceetm dce qbman_userspace eth-config crconf iperf optee_os optee_client optee_test secure_obj libpkcs11 qoriq-edgescale-eds qoriq-eds-kubelet qoriq-eds-bootstrap openstack-nova"
-ubuntu_extra_packages="wpasupplicant hostapd iw"
 
 # default git tree and branch
 default_uboot_tree=u-boot
@@ -130,6 +130,8 @@ rcw_repo_url=https://github.com/Scalys/rcw.git
 rcw_repo_branch=trustbox-1903
 atf_repo_tag=LSDK-19.03
 mc_utils_repo_tag=LSDK-19.03
+ppa_generic_repo=ppa-generic
+ppa_generic_repo_tag=LSDK-18.09
 qoriq_mc_binary_repo_url=https://github.com/nxp/qoriq-mc-binary.git
 qoriq_mc_binary_repo_tag=LSDK-19.03
 qoriq_qe_ucode_repo_url=https://github.com/nxp/qoriq-qe-ucode.git
diff --git a/packages/firmware/Makefile b/packages/firmware/Makefile
index 5b863cb..70af96a 100644
--- a/packages/firmware/Makefile
+++ b/packages/firmware/Makefile
@@ -11,7 +11,7 @@ include $(FBDIR)/configs/$(CONFIGLIST)
 include $(FBDIR)/include/repo.mk
 
 
-firmware: uboot uefi rcw atf mc-utils bin-firmware
+firmware: uboot uefi rcw atf ppa-generic mc-utils bin-firmware
 
 uboot:
 ifeq ($(CONFIG_BUILD_UBOOT), y)
@@ -58,9 +58,7 @@ else
 	 else \
 	     brdmsk=*$(MACHINE)*; \
 	 fi && \
-	 if [ $(MACHINE) = trustbox ]; then \
-	     $(call build-uboot-target,trustbox_defconfig) \
-	 elif [ -z "$(BOOTTYPE)" ]; then \
+	 if [ -z "$(BOOTTYPE)" ]; then \
 	     $(call fbprint_e,"please specify -b boottype parameter for u-boot on $(MACHINE)"); \
 	     exit; \
 	 else \
@@ -163,6 +161,19 @@ endif
 endif
 
 
+.PHONY: ppa-generic
+ppa-generic:
+ifeq ($(MACHINE), trustbox)
+ifeq ($(CONFIG_BUILD_PPA), y)
+	@$(call fbprint_b,"ppa-generic")
+	@$(call fetch-git-tree,$(ppa_generic_repo))
+	@test -d $(FBDIR)/build/firmware/ppa-generic || mkdir -p $(FBDIR)/build/firmware/ppa-generic/$(MACHINE)
+	@cd $(FBDIR)/packages/firmware/ppa-generic/ppa/ && ./build prod rdb-fit ls1012 && \
+	cp soc-ls1012/build/obj/ppa.itb $(FBDIR)/build/firmware/ppa-generic/$(MACHINE);
+endif
+endif
+
+
 .PHONY: atf
 atf:
 ifeq ($(CONFIG_BUILD_ATF), y)
diff --git a/tools/flex-builder b/tools/flex-builder
index cb5efba..11117a4 100755
--- a/tools/flex-builder
+++ b/tools/flex-builder
@@ -181,7 +181,7 @@ generate_qoriq_composite_firmware() {
 	fi
     fi
 
-    if [ $DESTARCH = arm32 ] && [ $1 = ls1043ardb -o $1 = ls1046ardb -o $1 = ls1012ardb -o $1 = ls1012afrwy -o $1 = trustbox]; then
+    if [ $DESTARCH = arm32 ] && [ $1 = ls1043ardb -o $1 = ls1046ardb -o $1 = ls1012ardb -o $1 = ls1012afrwy ]; then
 	echo $distroboot | sed -e 's/Image/uImage.v8/g' -e 's/booti/bootm/g' >> $FBDIR/$uboot_scr
 	kernel_img=`echo $kernel_img | sed  -e 's/arm64/arm32/g' -e 's/Image/uImage.v8/g'`
     fi
-- 
2.20.1

