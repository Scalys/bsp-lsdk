From 71e14457d890a9d1f320717a4a5ef4fba279b86f Mon Sep 17 00:00:00 2001
From: Nicholas Pridybailo <nikolai.pridybailo@edality.by>
Date: Thu, 25 Apr 2019 17:36:08 +0300
Subject: Implement 'mkfw' command support for trustbox machine Usage:
 flex-builder -i mkfw -m trustbox -b qspi

---
 configs/board/trustbox/manifest |  5 ++-
 packages/firmware/Makefile      |  1 +
 tools/flex-builder              | 78 +++++++++++++++++++++++++++++++++
 3 files changed, 83 insertions(+), 1 deletion(-)

diff --git a/configs/board/trustbox/manifest b/configs/board/trustbox/manifest
index 4d298fb..a604c16 100644
--- a/configs/board/trustbox/manifest
+++ b/configs/board/trustbox/manifest
@@ -5,9 +5,12 @@ machine=trustbox
 kernel_img=build/linux/kernel/arm64/LS/Image
 device_tree=build/linux/kernel/arm64/LS/trustbox.dtb
 
-# [firmware_images]
+# [qspi firmware]
 rcw_qspi=build/firmware/rcw/trustbox/N_SSNH_3308/rcw_800.bin.swapped
 uboot_qspiboot=build/firmware/u-boot/trustbox/uboot_trustbox_qspi.bin
+ppa_fw=build/firmware/ppa-generic/trustbox/ppa.itb
 pfe_fw=build/firmware/qoriq-engine-pfe-bin/ls1012a/u-boot/pfe_fw_sbl.itb
+
+# [kernel fw]
 pfe_kernel=build/firmware/qoriq-engine-pfe-bin/ls1012a/slow_path/ppfe*.elf
 rtl8723bu_fw=build/linux/linux/arm64/LS/lib/firmware/rtl_bt/rtl8723b_fw.bin
diff --git a/packages/firmware/Makefile b/packages/firmware/Makefile
index 70af96a..94a689b 100644
--- a/packages/firmware/Makefile
+++ b/packages/firmware/Makefile
@@ -170,6 +170,7 @@ ifeq ($(CONFIG_BUILD_PPA), y)
 	@test -d $(FBDIR)/build/firmware/ppa-generic || mkdir -p $(FBDIR)/build/firmware/ppa-generic/$(MACHINE)
 	@cd $(FBDIR)/packages/firmware/ppa-generic/ppa/ && ./build prod rdb-fit ls1012 && \
 	cp soc-ls1012/build/obj/ppa.itb $(FBDIR)/build/firmware/ppa-generic/$(MACHINE);
+	@$(call fbprint_d,"ppa-generic")
 endif
 endif
 
diff --git a/tools/flex-builder b/tools/flex-builder
index 11117a4..121c89a 100755
--- a/tools/flex-builder
+++ b/tools/flex-builder
@@ -102,6 +102,81 @@ check_build_toolchain() {
 }
 
 
+generate_trustbox_composite_firmware() {
+    if [ ! -f $FBDIR/configs/board/${MACHINE}/manifest ]; then
+	echo $FBDIR/configs/board/${MACHINE}/manifest not exist!
+	exit 1
+    fi
+    . $FBDIR/configs/board/${MACHINE}/manifest
+
+	local build_dir=$FBDIR/build/images/${MACHINE}
+	local fwimg=${build_dir}/${MACHINE}_${BOOTTYPE}_fw.itb
+	local rcwimg=`eval echo '${'"rcw_""${BOOTTYPE}"'}'`
+	local bootloaderimg=`eval echo '${uboot_'"${BOOTTYPE}"'boot}'`
+
+	if [ -z "$bootloaderimg" ]; then
+		echo Error: uboot_${BOOTTYPE}boot on ${MACHINE} unsupported!
+		exit
+	elif [ -n "$bootloaderimg" ] && [ ! -f $FBDIR/$bootloaderimg ]; then
+		echo $bootloaderimg not exist, generating it ...
+		flex-builder -c uboot -m ${MACHINE} -b ${BOOTTYPE}
+	fi
+
+	if [ -z "$rcwimg" ]; then
+		echo Error: rcw_${BOOTTYPE} on ${MACHINE} unsupported!
+		exit
+	elif [ -n "$rcwimg" ] && [ ! -f $FBDIR/$rcwimg ]; then
+		echo $rcwimg not exist, generating it ...
+		flex-builder -c rcw -m ${MACHINE}
+	fi
+
+	if [ -z "$pfe_fw" ]; then
+		echo Error: $pfe_fw on ${MACHINE} unsupported!
+		exit
+	elif [ -n "$pfe_fw" ] && [ ! -f $FBDIR/$pfe_fw ]; then
+		echo $pfe_fw not exist, generating it ...
+		flex-builder -c qoriq-engine-pfe-bin -m ${MACHINE}
+	fi
+
+	if [ -z "$ppa_fw" ]; then
+		echo Error: $ppa_fw on ${MACHINE} unsupported!
+		exit
+	elif [ -n "$ppa_fw" ] && [ ! -f $FBDIR/$ppa_fw ]; then
+		echo $ppa_fw not exist, generating it ...
+		flex-builder -c ppa-generic -m ${MACHINE}
+	fi
+
+	test ! -d ${build_dir} && mkdir $build_dir
+	if [ -e ${fwimg} ]; then
+		rm -f ${fwimg}
+	fi
+
+	if [ -e ${build_dir}/components ]; then
+		rm -rf ${build_dir}/components/*
+	else
+		mkdir ${build_dir}/components
+	fi
+
+	cp ${rcwimg} ${build_dir}/components/rcw.bin
+	cp ${bootloaderimg} ${build_dir}/components/u-boot.bin
+	cp ${pfe_fw} ${build_dir}/components/pfe.itb
+	cp ${ppa_fw} ${build_dir}/components/ppa.itb
+
+	local block_size=256
+	local rcw_offset=`echo "$(( 0x00000000 / "$block_size" ))"`
+	local bootloader_offset=`echo "$(( 0x00010000 / "$block_size" ))"`
+	local pfe_fw_offset=`echo "$(( 0x00240000 / "$block_size" ))"`
+	local ppa_fw_offset=`echo "$(( 0x00280000 / "$block_size" ))"`
+	dd if=/dev/zero bs=1M count=64 | tr '\000' '\377' > ${fwimg}
+	dd if=${rcwimg} of=${fwimg} obs=${block_size} seek=${rcw_offset} conv=notrunc
+	dd if=${bootloaderimg} of=${fwimg} obs=${block_size} seek=${bootloader_offset} conv=notrunc
+	dd if=${pfe_fw} of=${fwimg} obs=${block_size} seek=${pfe_fw_offset} conv=notrunc
+	dd if=${ppa_fw} of=${fwimg} obs=${block_size} seek=${ppa_fw_offset} conv=notrunc
+
+	echo -e "${GREEN} $fwimg [Done]\n${NC}"
+}
+
+
 generate_qoriq_composite_firmware() {
     # generate machine-specific firmware to be programmed to NOR/SD media
     # $1: machine name
@@ -2394,6 +2469,7 @@ if [ "$MACHINE" = "ls1021atwr" ]; then
     DESTARCH=arm32
 fi
 if [ "$MACHINE" = "trustbox" ]; then
+	DESTARCH=arm64
 	if [ -z $CONFIGLIST ]; then
 		CONFIGLIST=trustbox.cfg
 		echo "CONFIGLIST: $CONFIGLIST"
@@ -2775,6 +2851,8 @@ case "$INSTRUCTION" in
 		    fi
 		fi
 	    done
+	elif [ "$MACHINE" = "trustbox" ]; then
+	    generate_trustbox_composite_firmware
 	elif [ "$MACHINE" = "ls1012afrwy" ]; then
 	    generate_composite_firmware_2M $MACHINE $BOOTTYPE $BUILDARG
 	    generate_composite_firmware_2M $MACHINE $BOOTTYPE $BUILDARG 512mb
-- 
2.20.1

