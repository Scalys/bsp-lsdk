From 9520441c0dbcbee73da77d25ab4de894fbef63ca Mon Sep 17 00:00:00 2001
From: Nicholas Pridybailo <nikolai.pridybailo@edality.by>
Date: Fri, 7 Jun 2019 18:07:07 +0300
Subject: Add optee_examples to apps list

---
 configs/trustbox.cfg   |  4 +++-
 packages/apps/Makefile | 28 ++++++++++++++++++++++++++--
 2 files changed, 29 insertions(+), 3 deletions(-)

diff --git a/configs/trustbox.cfg b/configs/trustbox.cfg
index b30a10b..5caf5d0 100644
--- a/configs/trustbox.cfg
+++ b/configs/trustbox.cfg
@@ -101,7 +101,7 @@ fbdockerimgversion=18.04
 # component repository list for autobuild
 firmware_repo_list="atf u-boot qoriq-uefi-binary qoriq-fm-ucode mc-utils qoriq-mc-binary qoriq-qe-ucode qoriq-firmware-cortina qoriq-firmware-inphi qoriq-engine-pfe-bin ddr-phy-binary"
 linux_repo_list="linux cryptodev-linux lttng-modules rtl8723bu"
-apps_repo_list="restool flib fmlib fmc spc dpdk vpp pktgen-dpdk ovs-dpdk openssl gpp-aioptool cst aiopsl ptpd ceetm dce qbman_userspace eth-config crconf iperf optee_os optee_client optee_test secure_obj libpkcs11 qoriq-edgescale-eds qoriq-eds-kubelet qoriq-eds-bootstrap openstack-nova azure-iotedge ftpm"
+apps_repo_list="restool flib fmlib fmc spc dpdk vpp pktgen-dpdk ovs-dpdk openssl gpp-aioptool cst aiopsl ptpd ceetm dce qbman_userspace eth-config crconf iperf optee_os optee_client optee_test optee_examples secure_obj libpkcs11 qoriq-edgescale-eds qoriq-eds-kubelet qoriq-eds-bootstrap openstack-nova azure-iotedge ftpm"
 
 # default git tree and branch
 default_uboot_tree=u-boot
@@ -206,3 +206,5 @@ azure_libiothsm_deb_name=libiothsm-std_1.0.8~dev-1_arm64.deb
 azure_libiothsm_deb_url=https://www.grapeboard.com/wp-content/pkgs/lsdk-1903/libiothsm-std_1.0.8~dev-1_arm64.deb
 ftpm_repo_url=https://github.com/Microsoft/ms-tpm-20-ref.git
 ftpm_repo_commit=d979cae6db01ea2e57dbce92d700ce1d0edf78fa
+optee_examples_repo_url=https://github.com/linaro-swg/optee_examples.git
+optee_examples_repo_commit=12f215a2a2123e4b9b28c203e3c5dfca51239e7f
diff --git a/packages/apps/Makefile b/packages/apps/Makefile
index 421e7bf..ba68887 100644
--- a/packages/apps/Makefile
+++ b/packages/apps/Makefile
@@ -281,7 +281,7 @@ endif
 endif
 
 
-optee: optee_os optee_client optee_test
+optee: optee_os optee_client optee_test optee_examples
 
 .PHONY: optee_os
 optee_os:
@@ -334,7 +334,6 @@ endif
 optee_test:
 ifeq ($(CONFIG_BUILD_OPTEE), y)
 ifeq ($(DESTARCH),arm64)
-ifeq ($(CONFIG_BUILD_OPTEE), y)
 	@if [ ! -f $(DESTDIR)/lib/libteec.so.1.0 -o ! -d $(FBDIR)/packages/apps/optee_client ]; then \
 		$(call fbprint_n,"Optee-client required and not built yet. Building...");\
 		cd $(FBDIR) && flex-builder -c optee_client -a $(DESTARCH) -m $(MACHINE);\
@@ -356,6 +355,31 @@ ifeq ($(CONFIG_BUILD_OPTEE), y)
 	@$(call fbprint_d,"OPTEE_TEST")
 endif
 endif
+
+.PHONY: optee_examples
+optee_examples:
+ifeq ($(CONFIG_BUILD_OPTEE), y)
+ifeq ($(DESTARCH),arm64)
+	@if [ ! -f $(DESTDIR)/lib/libteec.so.1.0 -o ! -d $(FBDIR)/packages/apps/optee_client ]; then \
+		$(call fbprint_n,"Optee-client required and not built yet. Building...");\
+		cd $(FBDIR) && flex-builder -c optee_client -a $(DESTARCH) -m $(MACHINE);\
+	fi;
+	@if [ ! -f $(FBDIR)/build/firmware/optee/tee_$(MACHINE).bin -o ! -d $(FBDIR)/packages/apps/optee_os ]; then \
+		$(call fbprint_n,"Optee-OS required and not built yet. Building...");\
+		cd $(FBDIR) && flex-builder -c optee_os -a $(DESTARCH) -m $(MACHINE);\
+	fi;
+	@$(call fbprint_b,"OPTEE_EXAMPLES")
+	@$(call fetch-git-tree,optee_examples)
+	@cd $(FBDIR)/packages/apps/optee_examples/; \
+	export TA_DEV_KIT_DIR=$(FBDIR)/packages/apps/optee_os/out/arm-plat-ls/export-ta_arm64/; \
+	export TEEC_EXPORT=$(FBDIR)/build/apps/components_LS_arm64/; \
+	export HOST_CROSS_COMPILE=aarch64-linux-gnu-; \
+	$(MAKE) clean; $(MAKE) -j$(JOBS); \
+	mkdir -p $(FBDIR)/build/apps/optee_examples_$(ARCH); \
+	rm -rf $(FBDIR)/build/apps/optee_examples_$(ARCH)/*; \
+	cp -r out/* $(FBDIR)/build/apps/optee_examples_$(ARCH)/;
+	@$(call fbprint_d,"OPTEE_EXAMPLES")
+endif
 endif
 
 
-- 
2.21.0

