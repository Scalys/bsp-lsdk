From 8ea28f0991c6057fa9b095ab6d9761ebb368eb90 Mon Sep 17 00:00:00 2001
From: Nicholas Pridybailo <nikolai.pridybailo@edality.by>
Date: Mon, 15 Apr 2019 11:50:11 +0300
Subject: [PATCH 4/9] Add target for rtl8723b firmware, add wireless network
 utils to trustbox packages list for Ubuntu

---
 configs/board/trustbox/manifest  |  7 +++---
 configs/trustbox.cfg             |  6 ++++-
 configs/ubuntu/packages_trustbox | 42 ++++++++++++++++++++++++++++++++
 packages/linux/Makefile          | 20 ++++++++++++++-
 tools/flex-builder               | 10 ++++++++
 5 files changed, 80 insertions(+), 5 deletions(-)
 create mode 100644 configs/ubuntu/packages_trustbox

diff --git a/configs/board/trustbox/manifest b/configs/board/trustbox/manifest
index 9ea8b19..111b518 100644
--- a/configs/board/trustbox/manifest
+++ b/configs/board/trustbox/manifest
@@ -16,9 +16,10 @@ atf_fip_uboot=build/firmware/atf/ls1012afrdm/fip_uboot.bin
 atf_fip_uboot_sec=build/firmware/atf/ls1012afrdm/fip_uboot_sec.bin
 pfe_fw=build/firmware/qoriq-engine-pfe-bin/ls1012a/u-boot/pfe_fw_sbl.itb
 pfe_kernel=build/firmware/qoriq-engine-pfe-bin/ls1012a/slow_path/ppfe*.elf
+rtl8723bu_fw=build/linux/linux/arm64/LS/lib/firmware/rtl_bt/rtl8723b_fw.bin
 secureboot_headers=null
 
 # [distro autoboot script]
-uboot_scr=build/firmware/u-boot/ls1012ardb/ls1012ardb_boot.scr
-bootscript_dec=build/firmware/u-boot/ls1012ardb/ls1012ardb_dec_boot.scr
-bootscript_enforce=build/firmware/u-boot/ls1012ardb/ls1012ardb_enforce_boot.scr
+uboot_scr=build/firmware/u-boot/trustbox/trustbox_boot.scr
+bootscript_dec=build/firmware/u-boot/trustbox/trustbox_dec_boot.scr
+bootscript_enforce=build/firmware/u-boot/trustbox/trustbox_enforce_boot.scr
diff --git a/configs/trustbox.cfg b/configs/trustbox.cfg
index 920dd4a..c131718 100644
--- a/configs/trustbox.cfg
+++ b/configs/trustbox.cfg
@@ -38,6 +38,7 @@ CONFIG_BUILD_OPTEE=n
 CONFIG_BUILD_LIBPKCS11=n
 CONFIG_BUILD_SECURE_OBJ=n
 CONFIG_BUILD_EDGESCALE=n
+CONFIG_BUILD_RTL8723BU=y
 
 # default i.MX ARM machine list for autobuild
 BUILD_IMX_IMAGE=n
@@ -97,8 +98,9 @@ fbdockerimgversion=18.04
 
 # component repository list for autobuild
 firmware_repo_list="atf u-boot qoriq-uefi-binary qoriq-fm-ucode mc-utils qoriq-mc-binary qoriq-qe-ucode qoriq-firmware-cortina qoriq-firmware-inphi qoriq-engine-pfe-bin ddr-phy-binary"
-linux_repo_list="linux cryptodev-linux lttng-modules"
+linux_repo_list="linux cryptodev-linux lttng-modules rtl8723bu"
 apps_repo_list="restool flib fmlib fmc spc dpdk vpp pktgen-dpdk ovs-dpdk openssl gpp-aioptool cst aiopsl ptpd ceetm dce qbman_userspace eth-config crconf iperf optee_os optee_client optee_test secure_obj libpkcs11 qoriq-edgescale-eds qoriq-eds-kubelet qoriq-eds-bootstrap openstack-nova"
+ubuntu_extra_packages="wpasupplicant hostapd iw"
 
 # default git tree and branch
 default_uboot_tree=u-boot
@@ -143,6 +145,8 @@ qoriq_engine_pfe_bin_repo_url=https://github.com/nxp/qoriq-engine-pfe-bin.git
 qoriq_engine_pfe_bin_repo_tag=LSDK-19.03
 ddr_phy_binary_repo_url=https://github.com/nxp/ddr-phy-binary.git
 ddr_phy_binary_repo_tag=LSDK-19.03
+rtl8723bu_repo_url=https://github.com/lwfinger/rtl8723bu.git
+rtl8723bu_repo_branch=master
 
 # apps components git repositories
 restool_repo_tag=LSDK-19.03
diff --git a/configs/ubuntu/packages_trustbox b/configs/ubuntu/packages_trustbox
new file mode 100644
index 0000000..68b06b0
--- /dev/null
+++ b/configs/ubuntu/packages_trustbox
@@ -0,0 +1,42 @@
+
+# additional packages list for LSDK main userland gathered from main repo
+additional_main_packages_list="apt apt-utils git gcc vim wget make build-essential u-boot-tools
+ device-tree-compiler python python-dev ethtool zip libxml2-dev libsensors4-dev libssl-dev ftp
+ libedit-dev liblzma-dev binutils-dev autoconf automake dh-autoreconf libnuma-dev libpcap-dev
+ bc qemu-kvm bridge-utils libtool libncurses5-dev bison libelf-dev curl flex autotools-dev
+ openssh-server openssh-client tcpdump vlan ifenslave linux-tools-generic tftp-hpa tftpd-hpa
+ strace debootstrap mdadm vsftpd telnet sysstat rdate initramfs-tools mtd-utils dosfstools
+ net-tools iputils-ping hdparm psmisc keyutils python-numpy iw wpasupplicant hostapd bluez"
+
+# for devel userland gathered packages from universe/multiverse/restricted besides main repo
+additional_devel_packages_list="makedev tree lxc lxd virt-manager lm-sensors i2c-tools fio rt-tests
+ libcunit1-dev python-pip iperf netperf hugepages blktrace sysfsutils cpufrequtils iozone3 busybox
+ ipsec-tools lmbench watchdog libtclap-dev lttng-tools xterm can-utils python-virtualenv"
+
+
+# for Lite userland gathered from main repo
+additional_lite_packages_list="systemd udev net-tools iputils-ping isc-dhcp-client"
+
+
+# additional dependent packages for openstack-nova if CONFIG_BUILD_OPENSTACK_NOVA is enabled
+openstack_dependent_packages_list="python-pbr python-sqlalchemy python-decorator python-eventlet
+ python-jinja2 python-keystonemiddleware python-lxml python-routes python-cryptography python-webob
+ python-greenlet python-pastedeploy python-paste python-prettytable python-migrate python-netaddr
+ python-netifaces python-paramiko python-babel python-enum34 python-iso8601 python-jsonschema
+ python-cinderclient python-keystoneauth1 python-neutronclient python-glanceclient python-requests
+ python-six python-stevedore python-setuptools python-websockify python-oslo.cache python-oslo.concurrency
+ python-oslo.config python-oslo.context python-oslo.log python-oslo.reports python-oslo.serialization
+ python-oslo.utils python-oslo.db python-oslo.rootwrap python-oslo.messaging python-oslo.policy
+ python-oslo.privsep python-oslo.i18n python-oslo.service python-rfc3986 python-oslo.middleware
+ python-psutil python-oslo.versionedobjects python-os-brick python-os-traits python-os-vif python-os-win
+ python-castellan python-microversion-parse python-os-xenapi python-tooz python-cursive python-pypowervm
+ qemu-efi-aarch64"
+
+
+# source packages depended by some custom components.
+source_packages_list="iproute2"
+
+
+# extrinsic package needed by user but unavailable from official ubuntu
+extrinsic_packages_list=""
+
diff --git a/packages/linux/Makefile b/packages/linux/Makefile
index cbf1d3b..d11b690 100644
--- a/packages/linux/Makefile
+++ b/packages/linux/Makefile
@@ -13,7 +13,7 @@ include $(FBDIR)/include/repo.mk
 LINUX_REPO_LIST = $(KERNEL_TREE) cryptodev-linux
 ARM32_V8_DTB_LIST = freescale/fsl-ls1043a-rdb-sdk.dtb freescale/fsl-ls1046a-rdb-sdk.dtb freescale/fsl-ls1012a-rdb.dtb freescale/fsl-ls1012a-frwy.dtb
 
-all: setup-repo build-linux
+all: setup-repo build-linux rtl8723bu
 
 setup-repo:
 	@$(call fetch-git-tree,$(KERNEL_TREE))
@@ -157,6 +157,24 @@ else
 	@$(call fbprint_w,INFO: CONFIG_BUILD_LTTNG is not enabled by default in configs/$(CONFIGLIST))
 endif
 
+.PHONY: rtl8723bu
+rtl8723bu:
+ifeq ($(CONFIG_BUILD_RTL8723BU), y)
+	@$(call fetch-git-tree,rtl8723bu)
+	@$(call fetch-git-tree,$(KERNEL_TREE))
+	@if [ ! -d $(FBDIR)/build/linux/kernel/$(DESTARCH)/$(SOCFAMILY) ]; then cd $(FBDIR) && \
+	flex-builder -c linux -a $(DESTARCH) -f $(CONFIGLIST) && cd -; fi && \
+	echo -e "\nBuilding RTL8723BU module ..." && \
+	sed -i 's/EXTRA_CFLAGS += -DCONFIG_CONCURRENT_MODE/#EXTRA_CFLAGS  += -DCONFIG_CONCURRENT_MODE/g' rtl8723bu/Makefile && \
+	sed -i 's/#define CONFIG_IPS    1/\/\/#define CONFIG_IPS           1/g' rtl8723bu/include/autoconf.h && \
+	cd rtl8723bu && \
+	curbrch=`cd $(KERNEL_PATH) && git branch -v | grep '^*' | cut -d' ' -f2` && \
+	$(MAKE) KSRC=$(FBDIR)/build/linux/$(KERNEL_TREE)/$(DESTARCH)/$(SOCFAMILY)/output/$$curbrch && \
+	$(MAKE) -C $(FBDIR)/build/linux/$(KERNEL_TREE)/$(DESTARCH)/$(SOCFAMILY)/output/$$curbrch M=$(FBDIR)/packages/linux/rtl8723bu modules_install && \
+	install rtl8723b_fw.bin -D $(FBDIR)/build/linux/$(KERNEL_TREE)/$(DESTARCH)/$(SOCFAMILY)/lib/firmware/rtl_bt/rtl8723b_fw.bin && \
+	echo build and installed RTL8723BU module+firmware done!
+endif
+
 
 repo_fetch:
 	@echo -e "\nfetch linux repositories ..."
diff --git a/tools/flex-builder b/tools/flex-builder
index e35759a..cb5efba 100755
--- a/tools/flex-builder
+++ b/tools/flex-builder
@@ -1388,6 +1388,16 @@ merge_components() {
 	cd $FBDIR
     fi
 
+    #install RTL8723BU firmware to $RFSDIR/lib/firmware/
+       if [ $CONFIG_MACHINE_TRUSTBOX = y ]; then
+               if [ ! -f $FBDIR/build/linux/$KERNEL_TREE/$DESTARCH/$SOCFAMILY/lib/firmware/rtl_bt/rtl8723b_fw.bin  ]; then
+               flex-builder -c linux -a arm64 -m trustbox
+       fi
+               sudo mkdir -p $RFSDIR/lib/firmware/rtl_bt
+               . $FBDIR/configs/board/trustbox/manifest
+               sudo cp -f $FBDIR/$rtl8723bu_fw $RFSDIR/lib/firmware/rtl_bt/
+       fi
+
 	#install kernel, and dtb to $RFSDIR/boot/
 	if [ $CONFIG_MACHINE_TRUSTBOX = y ]; then
 		if [ ! -f $FBDIR/build/linux/$KERNEL_TREE/$DESTARCH/$SOCFAMILY/trustbox.dtb -o ! -f $FBDIR/build/linux/$KERNEL_TREE/$DESTARCH/$SOCFAMILY/uImage ]; then
-- 
2.20.1

