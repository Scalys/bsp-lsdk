From 478e3bcc4c3bada4cf0d0856c6c24ce0c71b15b2 Mon Sep 17 00:00:00 2001
From: Dmitry Lavnikevich <dmitry.lavnikevich@scalys.by>
Date: Thu, 30 Jul 2020 10:08:48 +0300
Subject: [PATCH 16/20] Implement ppa-generic build

---
 packages/firmware/Makefile | 30 +++++++++++++++++++++++++++---
 1 file changed, 27 insertions(+), 3 deletions(-)

diff --git a/packages/firmware/Makefile b/packages/firmware/Makefile
index 59a8214..23ac0a6 100644
--- a/packages/firmware/Makefile
+++ b/packages/firmware/Makefile
@@ -9,16 +9,40 @@ SHELL=/bin/bash
 include $(FBDIR)/configs/$(CONFIGLIST)
 include $(FBDIR)/include/repo.mk
 
-REPO_LIST = uboot uefi_bin rcw atf mc_utils fm_ucode qe_ucode mc_bin phy_cortina phy_inphi pfe_bin ddr_phy_bin dp_firmware_cadence
+REPO_LIST = uboot uefi_bin rcw atf mc_utils fm_ucode qe_ucode mc_bin phy_cortina phy_inphi ppa pfe_bin ddr_phy_bin dp_firmware_cadence
 FWDIR = $(PACKAGES_PATH)/firmware
 
-firmware: uboot uefi_bin rcw atf ppa-generic mc_utils bin_firmware
+firmware: uboot uefi_bin rcw atf ppa mc_utils bin_firmware
 
-bin_firmware: fm_ucode qe_ucode mc_bin phy_cortina phy_inphi pfe_bin ddr_phy_bin dp_firmware_cadence
+bin_firmware: fm_ucode qe_ucode mc_bin phy_cortina phy_inphi ppa-generic pfe_bin ddr_phy_bin dp_firmware_cadence
 
 include $(FBDIR)/packages/firmware/atf.mk
 include $(FBDIR)/packages/firmware/u-boot.mk
 
+.PHONY: ppa
+ppa:
+ifeq ($(MACHINE), trustbox)
+ifeq ($(CONFIG_FW_PPA), y)
+	@$(call fbprint_b,"ppa")
+        ifeq ($(CONFIG_APP_OPTEE), y)
+		@if [ ! -f $(FBDIR)/build/firmware/optee/tee_$(MACHINE).bin -o ! -d $(FBDIR)/packages/apps/optee_os ]; then \
+			$(call fbprint_n,"Optee-OS required and not built yet. Building...");\
+			cd $(FBDIR) && flex-builder -c optee_os -a $(DESTARCH) -m $(MACHINE);\
+		fi;
+        endif
+	@$(call fetch-git-tree,$(ppa_generic_repo))
+	@test -d $(FBDIR)/build/firmware/ppa_generic || mkdir -p $(FBDIR)/build/firmware/ppa_generic/$(MACHINE)
+	@cd $(FBDIR)/packages/firmware/ppa_generic/ppa/ && ./build clean ls1012
+        ifeq ($(CONFIG_APP_OPTEE), y)
+		@cp $(FBDIR)/build/firmware/optee/tee_$(MACHINE).bin $(FBDIR)/packages/firmware/ppa_generic/ppa/soc-ls1012/tee.bin
+		@cd $(FBDIR)/packages/firmware/ppa_generic/ppa/ && ./build prod rdb-fit spd=on ls1012
+        else
+		@cd $(FBDIR)/packages/firmware/ppa_generic/ppa/ && ./build prod rdb-fit ls1012
+        endif
+	@cp $(FBDIR)/packages/firmware/ppa_generic/ppa/soc-ls1012/build/obj/ppa.itb $(FBDIR)/build/firmware/ppa_generic/$(MACHINE)
+	@$(call fbprint_d,"ppa-generic")
+endif
+endif
 
 .PHONY: uefi_bin
 uefi uefi_bin:
-- 
2.27.0

