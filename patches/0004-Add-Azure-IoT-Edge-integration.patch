From 9906c634c38ba42bfde6a4f64588418823ed2768 Mon Sep 17 00:00:00 2001
From: Dmitry Lavnikevich <dmitry.lavnikevich@scalys.by>
Date: Mon, 11 May 2020 21:47:25 +0300
Subject: [PATCH 04/20] Add Azure IoT Edge integration

---
 configs/trustbox.cfg         |  3 ++-
 packages/apps/Makefile       |  1 +
 packages/apps/azure/azure.mk | 31 +++++++++++++++++++++++++++++++
 3 files changed, 34 insertions(+), 1 deletion(-)
 create mode 100644 packages/apps/azure/azure.mk

diff --git a/configs/trustbox.cfg b/configs/trustbox.cfg
index 92f07ef..b89ce04 100644
--- a/configs/trustbox.cfg
+++ b/configs/trustbox.cfg
@@ -48,12 +48,13 @@ CONFIG_APP_WAYLAND_PROTOCOLS=n
 CONFIG_APP_GPULIB=n
 CONFIG_APP_LIBDRM=y
 CONFIG_APP_WESTON=n
-CONFIG_APP_DOCKER_CE=y
+CONFIG_APP_DOCKER_CE=n
 CONFIG_APP_OPENSTACK_NOVA=n
 CONFIG_APP_OPTEE=y
 CONFIG_APP_LIBPKCS11=n
 CONFIG_APP_SECURE_OBJ=n
 CONFIG_APP_EDGESCALE=n
+CONFIG_APP_AZURE_IOTEDGE=y
 
 
 # set default build options for auto build
diff --git a/packages/apps/Makefile b/packages/apps/Makefile
index aa2c633..8575f51 100644
--- a/packages/apps/Makefile
+++ b/packages/apps/Makefile
@@ -24,3 +24,4 @@ include $(FBDIR)/packages/apps/security/security.mk
 include $(FBDIR)/packages/apps/edgescale/edgescale.mk
 include $(FBDIR)/packages/apps/networking/networking.mk
 include $(FBDIR)/packages/apps/multimedia/multimedia.mk
+include $(FBDIR)/packages/apps/azure/azure.mk
diff --git a/packages/apps/azure/azure.mk b/packages/apps/azure/azure.mk
new file mode 100644
index 0000000..f4b087b
--- /dev/null
+++ b/packages/apps/azure/azure.mk
@@ -0,0 +1,31 @@
+#
+# Copyright 2020 Scalys
+#
+# SPDX-License-Identifier: BSD-3-Clause
+#
+#
+# Azure Edge components from repository
+#
+
+
+.PHONY: azure_iotedge
+azure_iotedge:
+ifeq ($(CONFIG_APP_AZURE_IOTEDGE), y)
+	mkdir -p $(FBDIR)/packages/apps/azure/azure-iotedge && \
+	cd $(FBDIR)/packages/apps/azure/azure-iotedge && \
+	curl https://packages.microsoft.com/config/ubuntu/18.04/multiarch/prod.list > $(RFSDIR)/etc/apt/sources.list.d/microsoft-prod.list && \
+	curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > $(RFSDIR)/etc/apt/trusted.gpg.d/microsoft.gpg && \
+	echo "RFSDIR=$(RFSDIR)" && \
+	rm *.deb && \
+	wget "https://packages.microsoft.com/ubuntu/18.04/multiarch/prod/pool/main/m/moby-engine/moby-engine_3.0.11%2Bazure-2_arm64.deb" && \
+	wget "https://packages.microsoft.com/ubuntu/18.04/multiarch/prod/pool/main/m/moby-cli/moby-cli_3.0.11%2Bazure-2_arm64.deb" && \
+	wget "https://packages.microsoft.com/ubuntu/18.04/multiarch/prod/pool/main/libi/libiothsm-std/libiothsm-std_1.0.9-1_arm64.deb" && \
+	wget "https://packages.microsoft.com/ubuntu/18.04/multiarch/prod/pool/main/i/iotedge/iotedge_1.0.9-1_arm64.deb" && \
+	cp *.deb $(RFSDIR) && \
+	sudo ls && \
+	sudo chroot $(RFSDIR) dpkg -i --force-architecture "/moby-engine_3.0.11+azure-2_arm64.deb" && \
+	sudo chroot $(RFSDIR) dpkg -i --force-architecture "/moby-cli_3.0.11+azure-2_arm64.deb" && \
+	sudo chroot $(RFSDIR) dpkg -i --force-architecture "/libiothsm-std_1.0.9-1_arm64.deb" && \
+	sudo chroot $(RFSDIR) dpkg -i --force-architecture "/iotedge_1.0.9-1_arm64.deb" && \
+	sudo rm $(RFSDIR)/*.deb
+endif
-- 
2.27.0

